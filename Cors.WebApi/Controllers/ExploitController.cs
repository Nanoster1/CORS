using Microsoft.AspNetCore.Cors;
using Microsoft.AspNetCore.Mvc;

namespace Cors.WebApi.Controllers
{
    [ApiController]
    [Route("[controller]")]
    public class ExploitController : ControllerBase
    {
        private const string TestKey = "testkeyforsecret";
        private static readonly Dictionary<Guid, string> _secrets = new();
        private static int Counter = 0;

        [EnableCors("WithCredentials")]
        [HttpPost("set")]
        public ActionResult<string> Set()
        {
            var key = Guid.NewGuid();
            _secrets.Add(key, "SecretNumber" + Counter++.ToString());
            Response.Cookies.Append(TestKey, key.ToString());
            return "Secret generated";
        }

        [EnableCors("WithCredentials")]
        [HttpGet("get")]
        public ActionResult<string> Get()
        {
            var key = Request.Cookies[TestKey];
            if (key is null || !Guid.TryParse(key, out var keyGuid)) return BadRequest();
            return _secrets[keyGuid];
        }
    }
}